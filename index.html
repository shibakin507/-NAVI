<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta
  name="viewport"
  content="width=device-width,
           initial-scale=1.0,
           maximum-scale=1.0,
           user-scalable=no"
/>

<title>なんちゃってNAVI（ β版 ）</title>

<!-- ==================================================
     Leaflet / Plugins
================================================== -->
<script src="dist/leaflet.js"></script>
<link rel="stylesheet" href="dist/leaflet.css">

<script src="dist/leaflet-rotate.js"></script>

<script src="dist/jquery.min.js"></script>
<script src="dist/leaflet.geocsv.js"></script>

<link rel="stylesheet" href="dist/L.Control.Locate.min.css">
<script src="dist/L.Control.Locate.min.js"></script>

<!-- ==================================================
     Style
================================================== -->
<style>
    html, body, #mapcontainer {
        height: 100%;
        width: 100vw;
        margin: 0;
        padding: 0;
    }

    #chk {
        position: absolute;
        right: 12px;
        top: 70px;
        z-index: 1000;
    }

    /* Leaflet Rotate のコンパスを非表示 */
    .leaflet-compass,
    .leaflet-control-rotate {
        display: none !important;
    }

/* GPS ON 中だけ Locate ボタンを鼓動させる */
@keyframes locatePulse {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.6);
    }
    70% {
        transform: scale(1.15);
        box-shadow: 0 0 0 12px rgba(0, 0, 0, 0);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(0, 0, 0, 0);
    }
}

/* GPS ON（追跡中）のときだけ */
.leaflet-control-locate.active a {
    animation: locatePulse 1.2s infinite;
    border-radius: 50%;
}
  
</style>

<script>
/* ==================================================
   グローバル変数
================================================== */
let map;
let baseMaps;
let myMarker = null;

let currentBearing = 0;
const smooth = 0.15; // 地図回転の滑らかさ

/* ==================================================
   現在地アイコン（▲）
================================================== */
const myArrowIcon = L.divIcon({
    className: '',
    html: `
        <svg width="36" height="48" viewBox="0 0 60 100">
            <!-- 影（少し下にずらす） -->
            <polygon
                points="34,8 58,100 34,84 10,100"
                fill="rgba(0,0,0,0.5)"
            />
            <!-- 縁取り -->
            <polygon
                points="30,2 56,98 30,80 4,98"
                fill="#ffffff"
            />         
           <!-- 本体 -->
            <polygon
                id="myArrow"
                points="30,6 52,94 30,78 8,94"
                fill="#0000ff"
            />

        </svg>
    `,
    iconSize: [24, 36],
    iconAnchor: [12, 18]
});

/* ==================================================
   初期化
================================================== */
function init() {

    /* ---------- 地図初期化 ---------- */
    map = L.map('mapcontainer', {
        zoomControl: false,
        rotate: true,
        bearing: 0,
        compass: false
    });

    const startPoint = [35.35, 138.57];
    map.setView(startPoint, 11);

    L.tileLayer(
        'https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}',
        {
            attribution:
              "<a href='https://developers.google.com/maps/documentation' target='_blank'>Google Map</a>｜" +
              "<a href='http://fujisanwalker.blog.fc2.com/' target='_blank'>富士山Walker</a>"
        }
    ).addTo(map);

    L.control.scale({
        maxWidth: 200,
        position: 'topright',
        imperial: false
    }).addTo(map);

    /* ---------- GPS（Locate） ---------- */
    const lc = L.control.locate({
        position: "topleft",
        flyTo: false,
        showCompass: false,
        drawMarker: false,
        drawCircle: false,
        setView: 'once',
        watch: true,
        locateOptions: {
            enableHighAccuracy: true
        }
    }).addTo(map);

    map.on('locateactivate',   () => setArrowColor('#0000ff'));
    map.on('locatedeactivate', () => setArrowColor('#999999'));

    map.on('locationfound', e => {
        if (!myMarker) {
            myMarker = L.marker(e.latlng, {
                icon: myArrowIcon,
                interactive: false
            }).addTo(map);
        } else {
            myMarker.setLatLng([e.latitude + 0.00005, e.longitude]);
        }
    });

    /* ---------- CSVレイヤー ---------- */
    function createGeoCsv(url, defaultIcon) {

        const layer = L.geoCsv(null, {
            titles: ['lat', 'lng', 'icon', 'popup'],
            firstLineTitles: false,
            fieldSeparator: ',',

            onEachFeature: (feature, layer) => {
                layer.bindPopup(feature.properties.popup);
            },

            pointToLayer: (feature, latlng) => {
                return L.marker(latlng, {
                    icon: L.icon({
                        iconUrl: feature.properties.icon || defaultIcon,
                        shadowUrl: 'marker/shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [10, 43],
                        shadowSize: [41, 41],
                        shadowAnchor: [10, 43]
                    })
                });
            }
        });

        $.ajax({
            beforeSend: xhr => {
                xhr.overrideMimeType('text/csv;charset=UTF-8');
            },
            type: 'GET',
            dataType: 'text',
            url: url
        }).done(data => layer.addData(data));

        return layer;
    }

    const pointLayers = {
        "富士山世界遺産":        createGeoCsv('data/heritage.csv', ''),
        "富士山の眺望点":        createGeoCsv('data/fujiview.csv', ''),
        "夜景スポット":          createGeoCsv('data/nightview.csv', ''),
        "富士山自然休養林":      createGeoCsv('data/fujiforest.csv', ''),
        "その他スポット":        createGeoCsv('data/others.csv', ''),
        "バス停(2022年版)":      createGeoCsv('data/busstop.csv', '')
    };

    L.control.layers(null, pointLayers, {
        position: 'topleft'
    }).addTo(map);


/* ==================================================
   コース定義（配列）
================================================== */
const courseData = [
    {
        name: " ( コース図を選択してください )",
        file: "banner.png",
        bounds: [[35.3460, 138.6742], [35.3208, 138.6971]],
        opacity: 1.0
    },
    {
        name: "A.猪之頭 / 湧水を活かした産業",
        file: "inogashira.jpg",
        bounds: [[35.3795, 138.5556], [35.3591, 138.5729]],
        opacity: 0.8
    },
    {
        name: "B.上野 / 石造物をたずねる",
        file: "ueno.jpg",
        bounds: [[35.2919, 138.5609], [35.2671, 138.5832]],
        opacity: 0.8
    },
    {
        name: "C.上井出・白糸 / 富士の巻狩",
        file: "kamiide.jpg",
        bounds: [[35.3295, 138.5780], [35.2935, 138.6099]],
        opacity: 0.8
    },
    {
        name: "D.富士根北 / 道者道を歩く",
        file: "nekita.jpg",
        bounds: [[35.2752, 138.6432], [35.2436, 138.6705]],
        opacity: 0.8
    },
    {
        name: "E.北山 / 中道往還の旧道を歩く",
        file: "kitayama.jpg",
        bounds: [[35.2982, 138.5907], [35.2681, 138.6170]],
        opacity: 0.8
    },
    {
        name: "F.富丘 / 風祭の里を歩く",
        file: "tomioka.jpg",
        bounds: [[35.2522, 138.5815], [35.2276, 138.6027]],
        opacity: 0.8
    },
    {
        name: "G.泉・野中 / 飢渇川から潤井川",
        file: "izumi.jpg",
        bounds: [[35.2306, 138.5949], [35.2139, 138.6093]],
        opacity: 0.8
    },
    {
        name: "H.大宮西 / 旧大宮町西地区をめぐる",
        file: "westomiya.jpg",
        bounds: [[35.2396, 138.5981], [35.2208, 138.6145]],
        opacity: 0.8
    },
    {
        name: "H.大宮東 / 東大宮町東地区をめぐる",
        file: "eastomiya.jpg",
        bounds: [[35.2404, 138.6050], [35.2133, 138.6282]],
        opacity: 0.8
    },
    {
        name: "I.富士根南 / 泉と古墳をたずねる",
        file: "fujine.jpg",
        bounds: [[35.2403, 138.6251], [35.2135, 138.6483]],
        opacity: 0.8
    },
    {
        name: "J.黒田・星山 / 星山の手ひきと倭文神社",
        file: "hoshiyama.jpg",
        bounds: [[35.2211, 138.6011], [35.1951, 138.6230]],
        opacity: 0.8
    },
    {
        name: "K.白糸 / 昔話の里を歩く",
        file: "shiraito.jpg",
        bounds: [[35.3340, 138.5645], [35.3040, 138.5910]],
        opacity: 0.8
    },
    {
        name: "L.杉田 / 狸寺と子安神社をたずねる",
        file: "sugita.jpg",
        bounds: [[35.23451, 138.6449], [35.2078, 138.6679]],
        opacity: 0.8
    },
    {
        name: "M.山宮 / 山宮浅間神社と御神幸道",
        file: "yamamiya.jpg",
        bounds: [[35.2861, 138.6170], [35.2548, 138.6437]],
        opacity: 0.8
    },
    {
        name: "N.万野原新田 / 万野原開墾の歴史",
        file: "manno.jpg",
        bounds: [[35.2683, 138.6083], [35.2409, 138.6318]],
        opacity: 0.8
    },
    {
        name: "O.安居山 / 安沼用水の里を歩く",
        file: "agoyama.jpg",
        bounds: [[35.2293, 138.5767], [35.1975, 138.6041]],
        opacity: 0.8
    },
    {
        name: "P.沼久保 / 渡船と舟運の跡をたずねる",
        file: "numakubo.jpg",
        bounds: [[35.2070, 138.5814], [35.1884, 138.5976]],
        opacity: 0.8
    },
    {
        name: "Q.黒田・山本 / 山本勘助と俳人梅市の里",
        file: "kuroda.jpg",
        bounds: [[35.2237, 138.6107], [35.1970, 138.6336]],
        opacity: 0.8
    },
    {
        name: "R.上稲子 / 平家落人伝説の里をたずねる",
        file: "kamiinago.jpg",
        bounds: [[35.2836, 138.5172], [35.2504, 138.5455]],
        opacity: 0.8
    },
    {
        name: "S.上柚野・猫沢 / 柚野の里をめぐる北",
        file: "yuno.jpg",
        bounds: [[35.2793, 138.5470], [35.2529, 138.5698]],
        opacity: 0.8
    },
    {
        name: "T.下柚野・大鹿窪 / 柚野の里をめぐる南",
        file: "yuno2.jpg",
        bounds: [[35.2637, 138.5506], [35.2404, 138.5707]],
        opacity: 0.8
    },
    {
        name: "U.西山・大久保 / 西山本門寺をたずねる",
        file: "nishiyama.jpg",
        bounds: [[35.2480, 138.5499], [35.2139, 138.5791]],
        opacity: 0.8
    },
    {
        name: "V.羽鮒・長貫 / 富士川の歴史",
        file: "habuna.jpg",
        bounds: [[35.2134, 138.5526], [35.1866, 138.5757]],
        opacity: 0.8
    },
    {
        name: "W.内房 / 内房の里を歩く",
        file: "utsubusa.jpg",
        bounds: [[35.2135, 138.5375], [35.1830, 138.5630]],
        opacity: 0.8
    },
    
];

/* ==================================================
   baseMaps 生成
================================================== */
baseMaps = {};

courseData.forEach(c => {
    baseMaps[c.name] = L.imageOverlay(
        `data/${c.file}`,
        c.bounds,
        { opacity: c.opacity }
    );
});




    /* ---------- セレクトボックス ---------- */
    const selBox = L.control({ position: "topright" });
    selBox.onAdd = () => {
        const sel = L.DomUtil.create('select');
        sel.id = "selectBaseLayer";
        sel.onchange = baseLayerChage;
        return sel;
    };
    selBox.addTo(map);

    const sel = document.getElementById("selectBaseLayer");
    for (const key in baseMaps) {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = key;
        sel.appendChild(opt);
    }

    /* ---------- 方位センサー ---------- */
    setupOrientation();
    baseLayerChage();
}


/* ==================================================
   ▲色変更
================================================== */
function setArrowColor(color) {
    if (!myMarker) return;

    const el = myMarker.getElement();
    if (!el) return;

    const poly = el.querySelector('#myArrow');
    if (poly) poly.setAttribute('fill', color);
}

/* ==================================================
   方位センサー（iOS / Android）
================================================== */
function setupOrientation() {

    const requestPermission = () => {

        // iOS
        if (typeof DeviceOrientationEvent?.requestPermission === "function") {
            DeviceOrientationEvent.requestPermission()
                .then(res => {
                    if (res === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation, true);
                    }
                })
                .catch(console.error);

        // Android
        } else {
            const eventName =
                ("ondeviceorientationabsolute" in window)
                ? "deviceorientationabsolute"
                : "deviceorientation";

            window.addEventListener(eventName, handleOrientation, true);
        }
    };

    // ユーザー操作で起動
    document.body.addEventListener('click', requestPermission, { once: true });
}

function handleOrientation(e) {
    if (!map) return;

    let heading = 0;

    if (e.webkitCompassHeading) {
        heading = e.webkitCompassHeading; // iOS
    } else if (e.alpha != null) {
        heading = e.alpha; // Android
    }

    if (!heading) return;

    const diff = ((heading - currentBearing + 540) % 360) - 180;
    currentBearing += diff * smooth;

    map.setBearing(currentBearing);
}

/* ==================================================
   ベースレイヤー切替
================================================== */
function baseLayerChage() {
    if (!baseMaps) return;

    // 全てのコースレイヤーを一旦削除
    for (const key in baseMaps) {
        if (map.hasLayer(baseMaps[key])) {
            map.removeLayer(baseMaps[key]);
        }
    }

    const sel = document.getElementById("selectBaseLayer");
    const key = sel.value;

    // 選択されたレイヤーを表示
    if (baseMaps[key]) {
        baseMaps[key].addTo(map);
        map.setView(baseMaps[key].getCenter(), 14);
    }

    // ボタンの状態を「消す（表示中）」に合わせてリセット
    const btn = document.getElementById("chk_btn");
    if (btn) btn.value = "消す"; 
}

/* ==================================================
   表示 ON / OFF
================================================== */
function OnOff() {
    const btn = document.getElementById("chk_btn");
    const sel = document.getElementById("selectBaseLayer");
    const key = sel.value;

    if (!baseMaps[key]) return;

    // 地図上にレイヤーがあるかチェック
    if (map.hasLayer(baseMaps[key])) {
        // 表示中なら消す
        map.removeLayer(baseMaps[key]);
        btn.value = "出す";
    } else {
        // 消えているなら出す
        baseMaps[key].addTo(map);
        btn.value = "消す";
    }
}

</script>
</head>
<body onload="init()">
    <div id="mapcontainer"></div>
    <div id="chk">
        <input type="button" id="chk_btn" value="出す / 消す" onclick="OnOff();">
    </div>
</body>
</html>

